# 議事録: 認証機能デバッグとAI駆動開発講義ノート

_作成日: 2025/02/17_

## 1. 現状と課題
- **認証機能デバッグ**  
  - Supabase Auth Helpers を利用した認証フローは実装済みだが、テストユーザー作成時に `profiles` テーブルへのレコードが生成されない。
  - トリガー関数 (`handle_new_user`) が発火しているか、ログが取得できていない状況。
- **今後のタスク**  
  - ログ出力方法・設定の再確認、トリガー関数の簡易化による動作確認
  - `create-test-user.ts` の修正（user_metadata 追加）とCI/CD環境での動作検証

---

## 2. Supabaseについて
### 特徴
- **PostgreSQLデータベース**: SQLを用いた操作とシンプルなスキーマ管理
- **認証機能**: ユーザー登録、ログイン、パスワードリセット、ソーシャルログイン対応
- **リアルタイム機能**: データ変更を即時検知し、アプリに反映
- **ストレージ**: 画像や動画、その他ファイルの簡単アップロード・ダウンロード

### はじめ方
1. **アカウント登録**: Supabase公式サイトから無料アカウントを作成
2. **プロジェクト作成**: ダッシュボードから新規プロジェクトを設定
3. **データベース設定**: テーブル、トリガー、マイグレーションの適用  
4. **API利用**: 自動生成されるRESTful APIやリアルタイムAPIをフロントエンドと連携

### CLI操作例
- `supabase init`  
- `supabase link --project-ref [your ID] --password [your password]`  
- `supabase start`  
- `supabase db reset` と `supabase migration up`  
- Edge Functions や `supabase gen types` で型定義自動生成

---

## 3. Vercelについて
### 概要
- Next.jsとの高い親和性が特徴。自動デプロイ、グローバルCDN、サーバーレス関数が利用可能。

### 基本操作
- **CLIインストール**: `npm i -g vercel`
- **プロジェクトリンク**: `vercel link`
- **ローカル開発**: `vercel dev`（`--debug` オプションで詳細ログ）
- **デプロイ**: `vercel`（本番環境は `vercel --prod`）
- **環境変数管理**: `vercel env ls`、`vercel env add VARIABLE_NAME production`
- **ログ確認**: `vercel logs <deployment-url>`

---

## 4. CI/CDとGitHub Actions
### CI/CDパイプライン例
- **ワークフロー定義**: `.github/workflows/ci.yml`
- **ステップ**:
  1. コードのチェックアウト
  2. Node.js 環境セットアップ
  3. 依存関係のインストール (`npm ci`)
  4. Lint、TypeScript型チェック、ユニットテスト、APIテスト、DBテスト、統合テストの実行
  5. リポジトリ構成の検証（cursor-rule の利用）

### フローチャート例
```
Developer pushes code to GitHub
       ↓
GitHub Actions runs tests (Lint, Type Check, Unit/API/DB/Integration Tests)
       ↓
If tests pass → Merge PR into main branch
       ↓
Vercel receives webhook trigger → Pulls latest code → Builds & deploys
       ↓
Changes appear in Preview, then Production
```

---

## 5. cursorrule と TDDの推進
- **cursorrule**  
  - チームや個人開発における要件定義・テストファイル、型チェック等のルールをJSONで定義し、CI/CDで自動チェックを実施。
  - 例: `requirement-and-tdd-rule.json` により、必要なドキュメントやテストファイル、型チェックを強制。
- **利用方法**: `cursor lint` コマンド（カスタムスクリプト）で実行

---

## 6. Seleniumを用いたCWクローリング（実装詳細）
### 目的
- CWへの自動ログインおよび案件情報のクローリングを、Selenium + Headless Chrome で安定実行する。

### 実装要件
- **使用ライブラリ**: Node.js (LTS)、selenium-webdriver（最新安定版）、ChromeDriver（Chromeと同一バージョン）
- **ヘッドレスモード設定**: `--disable-gpu`、`--no-sandbox` オプションを追加

### 実装手順例
1. **ドライバ取得**: `npm install selenium-webdriver chromedriver`
2. **Seleniumセットアップ**:
    ```js
    import { Builder } from 'selenium-webdriver';
    import chrome from 'selenium-webdriver/chrome';

    const options = new chrome.Options()
      .headless()
      .addArguments('--disable-gpu', '--no-sandbox');

    const driver = new Builder()
      .forBrowser('chrome')
      .setChromeOptions(options)
      .build();
    ```
3. **CWログイン・案件取得処理**: ログイン → 案件一覧取得 → ページネーション対応
4. **データ保存**: JSON形式でまとめ、Supabaseへ保存
5. **リソース解放**: `driver.quit()`

### テスト・エラー対応
- GUIとヘッドレスモード両方でテスト
- OS間の互換性確認
- CI/CDでE2Eテストを実施、エラーレポート（Sentry等）の利用

---

## 7. SupabaseでのDB構築とCLI操作
- **プロジェクト作成**: Supabase CLI を用いて `supabase init`、`supabase link`、`supabase db push`
- **環境変数管理**: .envファイルにCAT EOFを利用して設定情報をアップデート
- **入力例**:
  - Project name: cw_project  
  - Project ID: ddphvogggubecycxaons  
  - APIキー、DB URL、JWT Secrets など

### 開通チェック
- curlコマンドでREST APIにアクセスし、200レスポンスを確認

---

## 8. GitHub Actions Workflowの例
```yaml
name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install Dependencies
        run: npm ci

      - name: Run Lint (ESLint)
        run: npm run lint

      - name: TypeScript Type Check
        run: npx tsc --noEmit --project tsconfig.json

      - name: Run Unit Tests (Vitest)
        run: npm run test:unit

      - name: Run API Tests
        run: npm run test:api

      - name: Run DB Tests
        run: npm run test:db

      - name: Run Integration Tests
        run: npm run test:integration

      - name: Validate Repository Structure with Cursor Rule
        run: npx cursor-rule run
```
- 各ステップの補足説明は、コードコメントや講義ノートを参照

---

## 9. 開発進捗と進め方
- **Branch運用**: 新機能着手時は必ずブランチを切り、安定版が完成したらmainにマージ
- **Pushタイミング**: 機能が安定した時点でプッシュし、Stable版を保存
- **開発フェーズ**:
  - **v1**: 仕様書、主たるテスト、DB/APIエンドポイント確定後、パフォーマンステスト・リファクタリング、書面化
  - **v2**: 新機能追加、DBテーブル拡張、カラム変更等

---

# 総括
本議事録は、現在の認証機能デバッグを中心に、Supabase、Vercel、CI/CD、cursorrule/TDD、SeleniumによるCWクローリング、そしてDB構築やGitHub Actionsによる自動デプロイの内容を網羅しています。これらの情報を基に、現状の問題解決とシステム全体の品質向上を目指してください。


### 参考URL:

